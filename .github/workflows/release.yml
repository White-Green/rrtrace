name: Build and Release

on: push

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'
          bundler-cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get version
        id: get_version
        shell: bash
        run: |
          set -euo pipefail

          VERSION=$(ruby -Ilib -r rrtrace/version -e 'puts Rrtrace::VERSION')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build native gem
        run: bundle exec rake native gem

      - name: Build source gem
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail

          gem build rrtrace.gemspec
          mkdir -p pkg
          mv rrtrace-${{ steps.get_version.outputs.version }}.gem pkg/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gems-${{ matrix.os }}
          path: pkg/*.gem

  release:
    name: Release Gems
    needs: build
    if: github.ref_name == github.event.repository.default_branch
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'
          bundler-cache: true

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: pkg
          merge-multiple: true

      - name: Configure RubyGems credentials
        uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Get version
        id: get_version
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(ruby -Ilib -r rrtrace/version -e 'puts Rrtrace::VERSION')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Publish to RubyGems
        shell: bash
        run: |
          set -euo pipefail

          VERSION=${{ steps.get_version.outputs.version }}

          # Fetch published versions from RubyGems API
          echo "Fetching published versions for rrtrace..."
          PUBLISHED_VERSIONS=$(curl -s https://rubygems.org/api/v1/versions/rrtrace.json)
          if ! echo "$PUBLISHED_VERSIONS" | jq -e 'type == "array"' >/dev/null 2>&1; then
            PUBLISHED_VERSIONS="[]"
          fi

          PUBLISHED_COUNT=0

          for gem_file in pkg/*.gem; do
            if [ ! -f "$gem_file" ]; then continue; fi
            GEM_FILENAME=$(basename $gem_file)
            PLATFORM=$(echo $GEM_FILENAME | sed -E "s/rrtrace-$VERSION-?//; s/\.gem$//")
            if [ -z "$PLATFORM" ]; then PLATFORM="ruby"; fi
          
            echo "Checking if $GEM_FILENAME (platform: $PLATFORM) is already published..."
          
            if echo "$PUBLISHED_VERSIONS" | jq -e ".[] | select(.number == \"$VERSION\" and .platform == \"$PLATFORM\")" > /dev/null 2>&1; then
              echo "$GEM_FILENAME is already published. Skipping."
            else
              echo "Publishing $GEM_FILENAME..."
              gem push $gem_file
              PUBLISHED_COUNT=$((PUBLISHED_COUNT + 1))
            fi
          done
          
          echo "PUBLISHED_COUNT=$PUBLISHED_COUNT" >> $GITHUB_ENV

      - name: Create Tag
        if: env.PUBLISHED_COUNT != '0'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="v${{ steps.get_version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists."
          else
            echo "Creating and pushing tag $VERSION..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "$VERSION"
            git push origin "$VERSION"
          fi
